#!/bin/bash
# Pre-commit hook: enforce CLI spawn rules for any file that spawns Claude CLI
#
# Rules (from CLAUDE.md § Claude CLI Integration):
#   Every .ts file that spawns Claude must include:
#     1. --verbose flag
#     2. stream-json output format
#     3. bypassPermissions permission mode
#     4. stdin?.end() or equivalent stdin close
#     5. delete env.ANTHROPIC_API_KEY (strip key from child env)

set -euo pipefail

STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=d | grep '\.ts$' || true)

if [ -z "$STAGED_TS_FILES" ]; then
  exit 0
fi

FAILED=0

for FILE in $STAGED_TS_FILES; do
  # Get the staged version of the file
  CONTENT=$(git show ":$FILE" 2>/dev/null || true)
  if [ -z "$CONTENT" ]; then
    continue
  fi

  # Check if this file spawns Claude CLI
  if ! echo "$CONTENT" | grep -qE 'spawn.*claude|spawn\(.*"claude"'; then
    continue
  fi

  # This file spawns Claude — enforce all rules
  MISSING=""

  if ! echo "$CONTENT" | grep -q '\-\-verbose'; then
    MISSING="${MISSING}\n  - Missing --verbose flag"
  fi

  if ! echo "$CONTENT" | grep -q 'stream-json'; then
    MISSING="${MISSING}\n  - Missing stream-json output format (found non-standard format)"
  fi

  if ! echo "$CONTENT" | grep -q 'bypassPermissions'; then
    MISSING="${MISSING}\n  - Missing bypassPermissions permission mode"
  fi

  if ! echo "$CONTENT" | grep -qE 'stdin.*end|stdin\?\.end'; then
    MISSING="${MISSING}\n  - Missing stdin.end() / stdin?.end() call (Claude CLI blocks on open stdin)"
  fi

  if ! echo "$CONTENT" | grep -q 'delete.*ANTHROPIC_API_KEY'; then
    MISSING="${MISSING}\n  - Missing 'delete env.ANTHROPIC_API_KEY' (must strip key from child process env)"
  fi

  if [ -n "$MISSING" ]; then
    echo "❌ BLOCKED: $FILE spawns Claude CLI but violates spawn rules:"
    echo -e "$MISSING"
    echo "   See CLAUDE.md § Claude CLI Integration"
    echo ""
    FAILED=1
  fi
done

if [ "$FAILED" -ne 0 ]; then
  echo "Pre-commit hook failed. Fix the issues above before committing."
  exit 1
fi
